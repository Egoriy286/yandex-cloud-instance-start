<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yandex Compute Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* По умолчанию (мобильная версия) */
        .mobile-card-view {
            display: block;
        }
        .desktop-table-view {
            display: none;
        }

        /* Десктопная версия (от 641px и выше) */
        @media screen and (min-width: 641px) {
            .mobile-card-view {
                display: none;
            }
            .desktop-table-view {
                display: table; /* или block/flex, если это не <table> */
            }
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between space-y-4 sm:space-y-0">
                <div class="flex items-center space-x-3">
                    <i class="fas fa-server text-blue-600 text-2xl"></i>
                    <h1 class="text-xl sm:text-2xl font-bold text-gray-900">Yandex Compute Dashboard</h1>
                </div>
                <div class="flex flex-wrap items-center gap-2">
                    <div id="uptime-display" class="px-3 py-1 rounded-lg bg-blue-50 text-sm font-medium text-blue-700">
                        <i class="fas fa-clock mr-2"></i>Uptime: <span id="server-uptime">-</span>
                    </div>
                    <div id="status-badge" class="px-3 py-1 rounded-full text-sm font-medium bg-gray-200 text-gray-700">
                        <i class="fas fa-circle-notch fa-spin mr-2"></i>Connecting...
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="refreshInstances()" class="px-3 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm">
                            <i class="fas fa-sync-alt mr-1"></i>Refresh
                        </button>
                        <button onclick="triggerAutoStart()" class="px-3 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors text-sm">
                            <i class="fas fa-play mr-1"></i>Auto-Start
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
        <!-- Stats Cards -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
            <div class="bg-white rounded-lg shadow-sm p-4 border border-gray-200">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-xs md:text-sm font-medium text-gray-600">Total Instances</p>
                        <p id="total-instances" class="text-xl md:text-3xl font-bold text-gray-900">-</p>
                    </div>
                    <div class="p-2 md:p-3 bg-blue-100 rounded-lg">
                        <i class="fas fa-server text-blue-600 text-lg md:text-xl"></i>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-sm p-4 border border-gray-200">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-xs md:text-sm font-medium text-gray-600">Running</p>
                        <p id="running-instances" class="text-xl md:text-3xl font-bold text-green-600">-</p>
                    </div>
                    <div class="p-2 md:p-3 bg-green-100 rounded-lg">
                        <i class="fas fa-play-circle text-green-600 text-lg md:text-xl"></i>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-sm p-4 border border-gray-200">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-xs md:text-sm font-medium text-gray-600">Stopped</p>
                        <p id="stopped-instances" class="text-xl md:text-3xl font-bold text-red-600">-</p>
                    </div>
                    <div class="p-2 md:p-3 bg-red-100 rounded-lg">
                        <i class="fas fa-stop-circle text-red-600 text-lg md:text-xl"></i>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-sm p-4 border border-gray-200">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-xs md:text-sm font-medium text-gray-600">Preemptible</p>
                        <p id="preemptible-instances" class="text-xl md:text-3xl font-bold text-yellow-600">-</p>
                    </div>
                    <div class="p-2 md:p-3 bg-yellow-100 rounded-lg">
                        <i class="fas fa-bolt text-yellow-600 text-lg md:text-xl"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Desktop Table View -->
        <div class="desktop-table-view bg-white rounded-lg shadow-sm border border-gray-200 sm:table">
            <div class="px-4 sm:px-6 py-4 border-b border-gray-200">
                <h2 class="text-lg font-semibold text-gray-900">Compute Instances</h2>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                            <th class="px-4 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            <th class="px-4 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Uptime</th>
                            <th class="px-4 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Zone</th>
                            <th class="px-4 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Resources</th>
                            <th class="px-4 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">IP Addresses</th>
                            <th class="px-4 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Platform</th>
                            <th class="px-4 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="instances-table-body" class="bg-white divide-y divide-gray-200">
                        <tr>
                            <td colspan="8" class="px-6 py-12 text-center text-gray-500">
                                <i class="fas fa-circle-notch fa-spin text-3xl mb-3"></i>
                                <p>Loading instances...</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Mobile Card View -->
        <div class="mobile-card-view grid grid-cols-1 gap-4 sm:hidden">
            <div id="instances-card-body">
                <div class="bg-white rounded-lg shadow-sm p-4 border border-gray-200 text-center">
                    <i class="fas fa-circle-notch fa-spin text-2xl mb-3 text-gray-400"></i>
                    <p class="text-gray-500">Loading instances...</p>
                </div>
            </div>
        </div>
    </main>

    <script>
        let allInstances = [];
        async function checkStatus() {
            try {
                const response = await fetch('api/status');
                const data = await response.json();
                
                if (data.status === 'healthy') {
                    document.getElementById('status-badge').innerHTML = 
                        '<i class="fas fa-check-circle mr-2"></i>Connected';
                    document.getElementById('status-badge').className = 
                        'px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-700';
                    document.getElementById('server-uptime').textContent = data.uptime || '-';
                } else {
                    throw new Error('Unhealthy status');
                }
            } catch (error) {
                document.getElementById('status-badge').innerHTML = 
                    '<i class="fas fa-exclamation-circle mr-2"></i>Disconnected';
                document.getElementById('status-badge').className = 
                    'px-3 py-1 rounded-full text-sm font-medium bg-red-100 text-red-700';
            }
        }

        async function startInstance(instanceId, instanceName) {
            if (!confirm(`Start instance "${instanceName}"?`)) return;
            
            try {
                const response = await fetch(`api/instances/${instanceId}/start`, {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (data.success) {
                    alert(`Instance "${instanceName}" is starting...`);
                    setTimeout(() => loadInstances(), 2000);
                } else {
                    alert('Failed to start instance');
                }
            } catch (error) {
                console.error('Error starting instance:', error);
                alert('Error starting instance');
            }
        }

        async function stopInstance(instanceId, instanceName) {
            if (!confirm(`Stop instance "${instanceName}"?`)) return;
            
            try {
                const response = await fetch(`api/instances/${instanceId}/stop`, {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (data.success) {
                    alert(`Instance "${instanceName}" is stopping...`);
                    setTimeout(() => loadInstances(), 2000);
                } else {
                    alert('Failed to stop instance');
                }
            } catch (error) {
                console.error('Error stopping instance:', error);
                alert('Error stopping instance');
            }
        }

        async function triggerAutoStart() {
            if (!confirm('Start all stopped instances?')) return;
            
            try {
                const response = await fetch(`api/auto-start`, {
                    method: 'POST'
                });
                const data = await response.json();
                
                const started = data.started?.length || 0;
                const failed = data.failed?.length || 0;
                
                alert(`Auto-start completed!\nStarted: ${started}\nFailed: ${failed}`);
                setTimeout(() => loadInstances(), 2000);
            } catch (error) {
                console.error('Error triggering auto-start:', error);
                alert('Error triggering auto-start');
            }
        }

        async function loadInstances() {
            try {
                const response = await fetch('api/instances');
                const data = await response.json();
                
                allInstances = data.instances || [];
                updateStats();
                renderInstances();
                renderMobileInstances();
            } catch (error) {
                console.error('Error loading instances:', error);
                document.getElementById('instances-table-body').innerHTML = 
                    '<tr><td colspan="8" class="px-6 py-8 text-center text-red-600"><i class="fas fa-exclamation-triangle mr-2"></i>Error loading instances</td></tr>';
                document.getElementById('instances-card-body').innerHTML = 
                    '<div class="bg-white rounded-lg shadow-sm p-4 border border-gray-200 text-center text-red-600"><i class="fas fa-exclamation-triangle mr-2"></i>Error loading instances</div>';
            }
        }

        function updateStats() {
            const total = allInstances.length;
            const running = allInstances.filter(i => i.status === 'RUNNING').length;
            const stopped = allInstances.filter(i => i.status === 'STOPPED').length;
            const preemptible = allInstances.filter(i => i.schedulingPolicy?.preemptible).length;

            document.getElementById('total-instances').textContent = total;
            document.getElementById('running-instances').textContent = running;
            document.getElementById('stopped-instances').textContent = stopped;
            document.getElementById('preemptible-instances').textContent = preemptible;
        }

        function formatMemory(bytes) {
            const mb = parseInt(bytes) / (1024 * 1024);
            return mb >= 1024 ? `${(mb / 1024).toFixed(1)} GB` : `${mb.toFixed(0)} MB`;
        }

        function getStatusBadge(status) {
            const statusColors = {
                'RUNNING': 'bg-green-100 text-green-800',
                'STOPPED': 'bg-red-100 text-red-800',
                'STARTING': 'bg-yellow-100 text-yellow-800',
                'STOPPING': 'bg-orange-100 text-orange-800'
            };
            
            const color = statusColors[status] || 'bg-gray-100 text-gray-800';
            return `<span class="px-2 py-1 rounded-full text-xs font-medium ${color}">${status}</span>`;
        }

        function calculateUptime(createdAt, status) {
            if (status !== 'RUNNING' || !createdAt) return '-';
            
            const created = new Date(createdAt);
            const now = new Date();
            const diff = now - created;
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            
            if (days > 0) {
                return `${days}d ${hours}h ${minutes}m`;
            } else if (hours > 0) {
                return `${hours}h ${minutes}m`;
            } else {
                return `${minutes}m`;
            }
        }

        function renderInstances() {
            const tbody = document.getElementById('instances-table-body');
            
            if (allInstances.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="px-6 py-8 text-center text-gray-500">No instances found</td></tr>';
                return;
            }

            tbody.innerHTML = allInstances.map(instance => {
                const resources = instance.resources || {};
                const networkInterfaces = instance.networkInterfaces || [];
                const primaryAddress = networkInterfaces[0]?.primaryV4Address || {};
                const publicIP = primaryAddress.oneToOneNat?.address || '-';
                const privateIP = primaryAddress.address || '-';
                const isPreemptible = instance.schedulingPolicy?.preemptible;
                const uptime = calculateUptime(instance.createdAt, instance.status);

                const actionButtons = instance.status === 'RUNNING' 
                    ? `<button onclick="stopInstance('${instance.id}', '${instance.name}')" 
                              class="px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600 text-xs">
                           <i class="fas fa-stop mr-1"></i>Stop
                       </button>`
                    : instance.status === 'STOPPED'
                    ? `<button onclick="startInstance('${instance.id}', '${instance.name}')" 
                              class="px-3 py-1 bg-green-500 text-white rounded hover:bg-green-600 text-xs">
                           <i class="fas fa-play mr-1"></i>Start
                       </button>`
                    : '<span class="text-xs text-gray-400">-</span>';

                return `
                    <tr class="hover:bg-gray-50 transition-colors">
                        <td class="px-4 sm:px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                <i class="fas fa-server text-gray-400 mr-3"></i>
                                <div>
                                    <div class="text-sm font-medium text-gray-900">${instance.name || 'N/A'}</div>
                                    <div class="text-xs text-gray-500 truncate max-w-[150px]">${instance.id}</div>
                                </div>
                            </div>
                        </td>
                        <td class="px-4 sm:px-6 py-4 whitespace-nowrap">
                            ${getStatusBadge(instance.status)}
                            ${isPreemptible ? '<span class="ml-1 px-2 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800"><i class="fas fa-bolt mr-1"></i>Preemptible</span>' : ''}
                        </td>
                        <td class="px-4 sm:px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            <i class="fas fa-clock text-gray-400 mr-2"></i>${uptime}
                        </td>
                        <td class="px-4 sm:px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            <i class="fas fa-map-marker-alt text-gray-400 mr-2"></i>${instance.zoneId || 'N/A'}
                        </td>
                        <td class="px-4 sm:px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-900">
                                <i class="fas fa-microchip text-gray-400 mr-2"></i>${resources.cores || 0} cores
                            </div>
                            <div class="text-xs text-gray-500">
                                <i class="fas fa-memory text-gray-400 mr-2"></i>${formatMemory(resources.memory || 0)}
                            </div>
                        </td>
                        <td class="px-4 sm:px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-900">
                                <i class="fas fa-globe text-gray-400 mr-2"></i>${publicIP}
                            </div>
                            <div class="text-xs text-gray-500">
                                <i class="fas fa-network-wired text-gray-400 mr-2"></i>${privateIP}
                            </div>
                        </td>
                        <td class="px-4 sm:px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            ${instance.platformId || 'N/A'}
                        </td>
                        <td class="px-4 sm:px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            ${actionButtons}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function renderMobileInstances() {
            const container = document.getElementById('instances-card-body');
            
            if (allInstances.length === 0) {
                container.innerHTML = '<div class="bg-white rounded-lg shadow-sm p-4 border border-gray-200 text-center text-gray-500">No instances found</div>';
                return;
            }

            container.innerHTML = allInstances.map(instance => {
                const resources = instance.resources || {};
                const networkInterfaces = instance.networkInterfaces || [];
                const primaryAddress = networkInterfaces[0]?.primaryV4Address || {};
                const publicIP = primaryAddress.oneToOneNat?.address || '-';
                const privateIP = primaryAddress.address || '-';
                const isPreemptible = instance.schedulingPolicy?.preemptible;
                const uptime = calculateUptime(instance.createdAt, instance.status);

                const actionButton = instance.status === 'RUNNING' 
                    ? `<button onclick="stopInstance('${instance.id}', '${instance.name}')" 
                              class="w-full mt-2 px-3 py-2 bg-red-500 text-white rounded hover:bg-red-600 text-sm">
                           <i class="fas fa-stop mr-1"></i>Stop Instance
                       </button>`
                    : instance.status === 'STOPPED'
                    ? `<button onclick="startInstance('${instance.id}', '${instance.name}')" 
                              class="w-full mt-2 px-3 py-2 bg-green-500 text-white rounded hover:bg-green-600 text-sm">
                           <i class="fas fa-play mr-1"></i>Start Instance
                       </button>`
                    : '';

                return `
                    <div class="bg-white rounded-lg shadow-sm p-4 border border-gray-200">
                        <div class="flex justify-between items-start mb-3">
                            <div class="flex items-center">
                                <i class="fas fa-server text-gray-400 mr-2"></i>
                                <div>
                                    <h3 class="font-medium text-gray-900">${instance.name || 'N/A'}</h3>
                                    <p class="text-xs text-gray-500 truncate max-w-[200px]">${instance.id}</p>
                                </div>
                            </div>
                            <div class="flex flex-col items-end">
                                ${getStatusBadge(instance.status)}
                                ${isPreemptible ? '<span class="mt-1 px-2 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800"><i class="fas fa-bolt mr-1"></i>Preemptible</span>' : ''}
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-3 text-sm mb-3">
                            <div class="flex items-center">
                                <i class="fas fa-clock text-gray-400 mr-2"></i>
                                <span class="text-gray-700">${uptime}</span>
                            </div>
                            <div class="flex items-center">
                                <i class="fas fa-map-marker-alt text-gray-400 mr-2"></i>
                                <span class="text-gray-700">${instance.zoneId || 'N/A'}</span>
                            </div>
                            <div class="flex items-center">
                                <i class="fas fa-microchip text-gray-400 mr-2"></i>
                                <span class="text-gray-700">${resources.cores || 0} cores</span>
                            </div>
                            <div class="flex items-center">
                                <i class="fas fa-memory text-gray-400 mr-2"></i>
                                <span class="text-gray-700">${formatMemory(resources.memory || 0)}</span>
                            </div>
                        </div>
                        
                        <div class="border-t border-gray-200 pt-3 mb-3">
                            <div class="flex items-center mb-1">
                                <i class="fas fa-globe text-gray-400 mr-2"></i>
                                <span class="text-sm text-gray-700">Public: ${publicIP}</span>
                            </div>
                            <div class="flex items-center">
                                <i class="fas fa-network-wired text-gray-400 mr-2"></i>
                                <span class="text-sm text-gray-700">Private: ${privateIP}</span>
                            </div>
                        </div>
                        
                        <div class="flex justify-between items-center border-t border-gray-200 pt-3">
                            <span class="text-sm text-gray-500">${instance.platformId || 'N/A'}</span>
                            ${actionButton}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function refreshInstances() {
            loadInstances();
            checkStatus();
        }

        // Initialize on page load
        window.addEventListener('DOMContentLoaded', () => {
            checkStatus();
            loadInstances();
            
            // Auto-refresh every 30 seconds
            setInterval(() => {
                checkStatus();
                loadInstances();
            }, 30000);
        });
    </script>
</body>
</html>